name: Security Scan
on:
  push:
    branches: ['**']

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for secret scanning
    
    # Secrets scanning
    - name: TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./

    # Better secret detection for passwords in dicts
    - name: detect-secrets scan
      uses: reviewdog/action-detect-secrets@master
      with:
        reporter: github-pr-review
    
    # Clone custom rule repositories
    - name: Get Trail of Bits rules
      run: git clone --depth 1 https://github.com/trailofbits/semgrep-rules.git /tmp/trailofbits-rules
    
    - name: Get elttam rules
      run: git clone --depth 1 https://github.com/elttam/semgrep-rules.git /elttam-rules
    
    - name: Get MobSF rules
      run: git clone --depth 1 https://github.com/MobSF/mobsfscan.git /mobsf-rules

    # SAST + Secrets
    - name: Semgrep Scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/secrets
          p/security-audit
          p/python
          r/python.lang.security.audit.hardcoded-password-string.hardcoded-password-string
          p/flask
          p/ci
          p/bandit
          p/trailofbits
          /elttam-rules/rules
          /mobsf-rules/mobsfscan/rules/semgrep
    
    # Dependency scanning
    - name: Trivy Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '0'
